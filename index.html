<!DOCTYPE html>
<html>
<head>
    <title>NASCAR Pick'em Scoreboard</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .race-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #1a365d;
            color: white;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 80px;
        }
        th {
            background-color: #1a365d;
            color: white;
            position: sticky;
            top: 0;
            cursor: pointer;
        }
        th .score {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }
        tr:nth-child(even) {
            background-color: #f0f4f8;
        }
        .position-col {
            background-color: #1a365d;
            color: white;
            font-weight: bold;
        }
        .car-number {
            color: #666;
            font-size: 0.9em;
        }
        .player-pick {
            background-color: #e2e8f0;
        }
        .last-fetch {
            font-size: 0.9em;
            color: #555;
        }

        /* Sticky pin for any selected player */
        .pin-column {
            position: sticky;
            left: 0;
            background-color: #ffffff;
            box-shadow: 2px 0px 5px rgba(0, 0, 0, 0.1);
        }

        /* Add space for the sticky first column */
        .sticky-cell {
            padding-left: 15px;
        }

        #player-select {
            margin-bottom: 15px;
            padding: 10px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="race-info">
        <div id="race-name"></div>
        <div id="race-status"></div>
        <div id="lap-counter"></div>
    </div>

    <!-- Dropdown to select the pinned player -->
    <div>
        <label for="player-select">Pin Player to Left: </label>
        <select id="player-select">
            <option value="">None</option>
            <!-- Player options will be populated here by JS -->
        </select>
    </div>

    <div class="card">
        <table id="pickem-grid">
            <thead>
                <tr id="header-row">
                    <th style="width: 100px">Position</th>
                    <th style="width: 80px">Car #</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="last-fetch">
        Last fetch time: <span id="last-fetch-time">N/A</span>
    </div>

    <script>
        const players = [
            { name: "Kris", picks: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"] },
            { name: "Breanna", picks: ["11", "12", "17", "24", "38", "54", "60", "71", "23", "34"] },
            { name: "Brian", picks: ["5", "8", "9", "22", "34", "41", "43", "84", "2", "6"] },
            { name: "Jana", picks: ["11", "12", "16", "22", "43", "2", "5", "6", "8", "9"] },
            { name: "Connor", picks: ["12", "22", "23", "24", "43", "48", "4", "5", "6", "8"] },
            { name: "Austin", picks: ["12", "16", "17", "22", "4", "5", "8", "9", "1", "77"] },
            { name: "Jeff", picks: ["16", "17", "22", "45", "48", "51", "56", "71", "1", "8"] },
            { name: "Travis", picks: ["17", "20", "23", "34", "41", "45", "47", "71", "1", "2"] },
            { name: "Nate", picks: ["12", "19", "22", "24", "34", "45", "71", "2", "8", "11"] },
            { name: "Tommy", picks: ["12", "17", "22", "23", "24", "40", "71", "2", "6", "8"] },
            { name: "Drew", picks: ["11", "12", "16", "22", "23", "24", "56", "71", "5", "6"] },
            { name: "Susan", picks: ["22", "23", "24", "45", "71", "2", "5", "6", "8", "10"] },
            { name: "Ash", picks: ["22", "23", "24", "40", "45", "48", "56", "2", "5", "11"] },
            { name: "Alora", picks: ["22", "23", "24", "45", "56", "71", "8", "9", "11", "12"] }
        ];

        const headerRow = document.getElementById('header-row');
        const playerSelect = document.getElementById('player-select');
        let pinnedPlayerName = '';

        // Populate the dropdown with player names
        players.forEach(player => {
            const option = document.createElement('option');
            option.value = player.name;
            option.textContent = player.name;
            playerSelect.appendChild(option);
        });

        playerSelect.addEventListener('change', () => {
            pinnedPlayerName = playerSelect.value;
            updateRaceData();  // Refresh data after pin change
        });

        async function updateRaceData() {
            try {
                const response = await fetch('https://cf.nascar.com/live/feeds/live-feed.json');
                const data = await response.json();

                document.getElementById('race-name').textContent = data.run_name;
                document.getElementById('race-status').textContent = `Stage ${data.stage.stage_num}`;
                document.getElementById('lap-counter').textContent = `Lap ${data.lap_number} of ${data.laps_in_race}`;

                const tbody = document.querySelector('#pickem-grid tbody');
                tbody.innerHTML = '';

                const playerScores = players.map(player => ({
                    name: player.name,
                    score: 0
                }));

                data.vehicles.forEach(vehicle => {
                    const row = tbody.insertRow();

                    row.innerHTML = `<td class="position-col">${vehicle.running_position}</td><td class="car-number">${vehicle.vehicle_number}</td>`;

                    players.forEach(player => {
                        const cell = row.insertCell();
                        if (player.picks.includes(vehicle.vehicle_number)) {
                            cell.textContent = vehicle.vehicle_number;
                            cell.className = 'player-pick';
                            const playerIndex = playerScores.findIndex(p => p.name === player.name);
                            playerScores[playerIndex].score += vehicle.running_position;
                        }
                    });
                });

                // Sort players based on their scores (ascending)
                playerScores.sort((a, b) => a.score - b.score);

                // If there is a pinned player, place their column first
                if (pinnedPlayerName) {
                    const pinnedPlayerIndex = playerScores.findIndex(player => player.name === pinnedPlayerName);
                    const pinnedPlayer = playerScores.splice(pinnedPlayerIndex, 1)[0];  // Remove pinned player
                    playerScores.unshift(pinnedPlayer);  // Add pinned player at the start
                }

                // Update the header columns and the player scores
                playerScores.forEach((player, index) => {
                    const scoreSpan = headerRow.children[index + 2].querySelector('.score');
                    scoreSpan.textContent = player.score;
                });

                // Sort the rows based on the player order
                const rows = Array.from(tbody.rows);
                rows.sort((rowA, rowB) => {
                    const scoreA = rowA.querySelector(`td:nth-child(${playerScores.findIndex(p => p.name === rowA.cells[1].textContent) + 3}`).textContent;
                    const scoreB = rowB.querySelector(`td:nth-child(${playerScores.findIndex(p => p.name === rowB.cells[1].textContent) + 3}`).textContent;
                    return parseInt(scoreA) - parseInt(scoreB);
                });

                // Append the sorted rows back to tbody
                rows.forEach(row => tbody.appendChild(row));

                // Pin the selected player to the left
                const selectedPlayer = pinnedPlayerName;
                if (selectedPlayer) {
                    const playerIndex = players.findIndex(player => player.name === selectedPlayer);
                    headerRow.children[playerIndex + 2].classList.add('pin-column');
                }

                // Update last fetch time
                const lastFetchTime = new Date().toLocaleTimeString();
                document.getElementById('last-fetch-time').textContent = lastFetchTime;

            } catch (error) {
                console.error('Error fetching race data:', error);
            }
        }

        // Set interval to refresh the data
        updateRaceData();
        setInterval(updateRaceData, 15000);
    </script>
</body>
</html>
